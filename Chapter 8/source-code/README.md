In this chapter we discuss the use of a CMS made entirely with Node.js.
The Keystone.js describes itself as an Open Source platform to create database-driven websites, it already has a core engine to build a powerful blog and it is much more than that. It is possible to build anything usinh Keystone.js.
One of the main attractions of the CMS is to use the Express Framework and Mongoose ODM, two tools that we already used in this book.
Due to a very recent framework, it comes only with a default simple theme using Bootstrap framework.

In this chapter, we will see how to build a new theme using all the features of the framework and how to extend it with new features.

In this chapter we will cover:
* How to install KeystoneJS.
* The keystoneJS Structure and features.
* How to customize using stylesheets.
* Dealing with themes and how to create a blog theme.
* How to extend core functionality to create models and views.

# What we are building

For this chapter we will take as a base a simple blog. We'll see how extending it and creating new pages that can be administered through a control panel, and will have a very similar result in the following figure:
- Insert Image BO5288_08_05.png

# Installing keystone.js
As we have already used in previous chapters, we will use the official Keystone.js yeoman generator.

You can find more information about the KeystoneJS this link: http://keystonejs.com/

1- Let's install the generator, open your terminal/sheel and type the following command:

	npm install keystone -g

# Creating the scaffold application

1- Create a folder called chapter-08.
2- Open your terminal/sheLl at the chapter-08 folder and type the following command:

	yo keystone

After this command, the keystone.js will trigger a series of questions about the basic configurations of the application, you must answer them as the following figure:
- Insert Image BO5288_08_01.png

3- The terminal output will be the following:

	Your KeystoneJS project is ready to go!

	For help getting started, visit http://keystonejs.com/guide

	We've included a test Mandrill API Key, which will simulate email
	sending but not actually send emails. Please replace it with your own
	when you are ready.

	We've included a demo Cloudinary Account, which is reset daily.
	Please configure your own account or use the LocalImage field instead
	before sending your site live.

	To start your new website, run "npm start".

Before starting the application, we need to correct two small bugs. At the time this book is being written the generator has this fault, however when the book is released this should have already been fixed.

## Fixing lint error

1- Open gulpfile.js at the root project folder and remove line 36 about lint task:

	watch:lint

2- Fixing admin user name, open Keystone.js file at the root folder and replace the following highlighted line of code:

	keystone.set('nav', {
		posts: ['posts', 'post-categories'],
		galleries: 'galleries',
		enquiries: 'enquiries',
		userAdmins: 'user-admins'
	});

That's all, we already have our blog. Let's check the result.

3- Open your terminal/shell and type the following command:

	gulp

4- Go to http://localhost:3000/, you must see the following result:
- Insert Image BO5288_08_02.png

As previously commented on, the interface is very simple, it can view the default informations generated by the generator including the information to User and password.

5- Click on signin link at the top right corner and fill the login form with the user and password from the previous image. The result will be the control panel as the following figure:
- Insert Image BO5288_08_09.png

Each link has a form to insert data for the blog, but don't worry about this at this time, later in the chapter we will see how to use the admin panel.

# Changing the default bootstrap theme

We will show two ways to customize our blog, one superficial, changing only the stylesheet, and a deeper changing all the page markup.
For the stylesheet changing we are using the http://bootswatch.com/ free bootstrap themes.
The bootstrap framework is very flexible for this, we will use a theme called superhero.

1- Go to http://bootswatch.com/superhero/_variables.scss url.

2- Copy the page content.

3- Inside public/styles/boostrap/bootstrap, create a new file called _theme_variables.scss and paste the code copied from bootswatch page.

4- Open public/styles/bootstrap/_bootstrap.scss and replace the following highlighted line:

	// Core variables and mixins
	@import "bootstrap/_theme_variables";
	@import "bootstrap/mixins";

Now we will repeat the step 1 and 2, but now with a different url.

5- Go to http://bootswatch.com/superhero/_bootswatch.scss url.

6- Copy the page content.

7- Create a file called _bootswatch.scss at: public/styles/bootstrap and paste the content.

8- Open public/styles/bootstrap/_bootstrap.scss and replace the following highlighted line:

	// Booswatch overhide classes
	@import "bootswatch";

Done, right now we have a different layout of the standard adopted by keystone.js, so let's see the result.

9- Open your terminal/shell and type the following command:

	gulp

10- Go to url: http://localhost:3000/, and you must see the following result:

- Insert Image BO5288_08_03.png

With this small change we can already see the results achieved, however it is a very superficial customization since we do not change any HTML markup file.

# Modifying the KeystoneJS core template path

Now let's do a little refactoring on templates directory.

1- Inside templates create a folder called default.

2- Move all files at the templates folder to the new default folder.

3- Copy all the contents from default folder and paste on a new folder called: newBlog.

The result will be the following image, but we need to change the keystone.js file to configure the new folder.

- Insert Image BO5288_08_04.png

4- Open keystone.js file at the root folder and replace the following lines:

	'views': 'templates/themes/newBlog/views',
	'emails': 'templates/themes/newBlog/emails',

Done, we create a folder to hold all our themes.

# Building our own theme
Now we will change the theme markup, this means that we will edit all the HTML files inside newBlog theme, we are using as reference and source the following free template from https://github.com/BlackrockDigital/startbootstrap-clean-blog our goal is to have a layout similar with the following image:

- Insert Image BO5288_08_05.png

1- Open templates/themes/newBlog/layouts/default.swig and add the following code to the <head> tag:

	{# Custom Fonts #}
			<link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
			<link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
			<link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>


2- Remove all lines between {# HEADER #} and {# JAVASCRIPT #} comments.

Not this action will remove all the content after body tag and the JavaScripts links at the bottom of the default.swig file.

3- Now place the following lines of code between {# HEADER #} and {# JAVASCRIPT #} comments:

		<div id="header">
				{# Customise your sites navigation by changing the navLinks Array in ./routes/middleware.js
				   ... or completely change this header to suit your design. #}

				<!-- Navigation -->
				<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
					<div class="container-fluid">
						<!-- Brand and toggle get grouped for better mobile display -->
						<div class="navbar-header page-scroll">
							<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
								<span class="sr-only">Toggle navigation</span>
								<span class="icon-bar"></span>
								<span class="icon-bar"></span>
								<span class="icon-bar"></span>
							</button>
							<a class="navbar-brand" href="/">newBlog</a>
						</div>
						<!-- Collect the nav links, forms, and other content for toggling -->
						<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
							<ul class="nav navbar-nav navbar-left">
								{%- for link in navLinks -%}
									{%- set linkClass = '' -%}
									{%- if link.key == section -%}
										{%- set linkClass = ' class="active"' -%}
									{%- endif %}
								<li{{ linkClass | safe }}>
									<a href="{{ link.href }}">{{ link.label }}</a>
								</li>
								{%- endfor %}
							</ul>
							<ul class="nav navbar-nav navbar-right">
								{% if user -%}
									{%- if user.canAccessKeystone -%}
									<li><a href="/keystone">Open Keystone</a></li>
								{%- endif -%}
									<li><a href="/keystone/signout">Sign Out</a></li>
								{%- else -%}
									<li><a href="/keystone/signin">Sign In</a></li>
								{%- endif %}
							</ul>
						</div>
						<!-- /.navbar-collapse -->
					</div>
					<!-- /.container -->
				</nav>
				<!-- Page Header -->
				<header class="intro-header">
					<div class="container">
						<div class="row">
							<div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
								<div class="site-heading">
									<h1>Node.js 6 Blueprints</h1>
									<hr class="small">
									<span class="subheading">A Clean Blog using KeystoneJS</span>
								</div>
							</div>
						</div>
					</div>
				</header>
			</div>

			{# BODY #}
			<div id="body">
				{# NOTE:
				   There is no .container wrapping class around body blocks to allow more flexibility in design.
				   Remember to include it in your templates when you override the intro and content blocks! #}

				{# The Intro block appears above flash messages (used for temporary information display) #}
				{%- block intro -%}{%- endblock -%}

				{# Flash messages allow you to display once-off status messages to users, e.g. form
				   validation errors, success messages, etc. #}
				{{ FlashMessages.renderMessages(messages) }}

				{# The content block should contain the body of your templates content #}
				{%- block content -%}{%- endblock -%}
			</div>

4- Open templates/themes/newBlog/views/blog.swig and replace the code with the following code:

	{% extends "../layouts/default.swig" %}

	{% macro showPost(post) %}
		<div class="post" data-ks-editable="editable(user, { list: 'Post', id: post.id })">
			<div class="post-preview">
			{% if post.image.exists %}
				<img src="{{ post._.image.fit(400,300) }}" class="img text-center" width="100%" height="260px">
			{% endif %}
				<a href="/blog/post/{{ post.slug }}">
					<h2 class="post-title">
						{{ post.title }}
					</h2>
					<h3 class="post-subtitle">
						{{ post.content.brief | safe }}
					</h3>
				</a>
				<p class="post-meta">Posted by <a href="#">
				{% if post.author %} {{ post.author.name.first }} {% endif %}
				</a> {% if post.publishedDate %}
					on {{ post._.publishedDate.format("MMMM Do, YYYY") }}
				{% endif %}
				{% if post.categories and post.categories.length %}
					in
					{% for cat in post.categories %}
						<a href="/blog/{{ cat.key }}">{{ cat.name }}</a>
							{% if loop.index < post.categories.length - 1 %}, {% endif %}
					{% endfor %}
				{% endif %}
				</p>
				{% if post.content.extended %}
					<a class="read-more" href="/blog/post/{{ post.slug }}">Read more...</a>
				{% endif %}
			</div>
			<hr>
		</div>
	{% endmacro %}

	{% block intro %}
		<div class="container">
			{% set title = "Blog" %}
			{% if data.category %}
				{% set title = data.category.name %}
			{% endif %}
			<h1>{{ title }}</h1>
		</div>
	{% endblock %}

	{% block content %}
		<div class="container">
			<div class="row">
				<div class="col-sm-8 col-md-9">
					{% if filters.category and not data.category %}
						<h3 class="text-muted">Invalid Category.</h3>
					{% else %}
						{% if data.posts.results.length %}
							{% if data.posts.totalPages > 1 %}
								<h4 class="text-weight-normal">Showing
									<strong>{{ data.posts.first }}</strong>
									to
									<strong>{{ data.posts.last }}</strong>
									of
									<strong>{{ data.posts.total }}</strong>
									posts.
								</h4>
							{% else %}
								<h4 class="text-weight-normal">Showing {{ utils.plural(data.posts.results.length, "* post") }}.</h4>
							{% endif %}
							<div class="blog">
								{% for post in data.posts.results %}
									{{ showPost(post) }}
								{% endfor %}
							</div>
							{% if data.posts.totalPages > 1 %}
								<ul class="pagination">
									{% if data.posts.previous %}
										<li>
											<a href="?page={{ data.posts.previous }}">
												<span class="glyphicon glyphicon-chevron-left"></span>
											</a>
										</li>
									{% else %}
										<li class="disabled">
											<a href="?page=1">
												<span class="glyphicon glyphicon-chevron-left"></span>
											</a>
										</li>
																	{% endif %}
										{% for p in data.posts.pages %}
											<li class="{% if data.posts.currentPage == p %}active{% endif %}">
												<a href="?page={% if p == "..." %}{% if i %}{{ data.posts.totalPages }}{% else %}1{% endif %}{% else %}{{ p }}{% endif %}">{{ p }}</a>
											</li>
										{% endfor %}
									{% if data.posts.next %}
										<li>
											<a href="?page={{ data.posts.next }}">
												<span class="glyphicon glyphicon-chevron-right"></span>
											</a>
										</li>
									{% else %}
										<li class="disabled">
											<a href="?page={{ data.posts.totalPages }}">
												<span class="glyphicon glyphicon-chevron-right"></span>
											</a>
										</li>
									{% endif %}
								</ul>
							{% endif %}
						{% else %}
							{% if data.category %}
								<h3 class="text-muted">There are no posts in the category {{ data.category.name }}.</h3>
							{% else %}
								<h3 class="text-muted">There are no posts yet.</h3>
							{% endif %}
						{% endif %}
					{% endif %}
				</div>
				{% if data.categories.length %}
				<div class="col-sm-4 col-md-3">
					<h2>Categories</h2>
					<div class="list-group" style="margin-top: 70px;">
						<a href="/blog" class="{% if not data.category %}active{% endif %} list-group-item">All Categories</a>
						{% for cat in data.categories %}
							<a href="/blog/{{ cat.key }}" class="{% if data.category and data.category.id == cat.id %}active{% endif %} list-group-item">{{ cat.name }}</a>
						{% endfor %}
					</div>
				</div>
				{% endif %}
			</div>
		</div>
	{% endblock %}

5- Open templates/themes/newBlog/views/contact.swig and replace the code with the following code:

	{% extends "../layouts/default.swig" %}

	{% block intro %}
		<div class="container">
			<h1>Contact Us</h1>
		</div>
	{% endblock %}

	{% block content %}
		<div class="container">
			{% if enquirySubmitted %}
				<h3>Thanks for getting in touch.</h3>
			{% else %}
				<div class="row control-group">
					<div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
						<form method="post">
							<input type="hidden" name="action" value="contact">
							{% set className = "" %}
							{% if validationErrors.name %}
								{% set className = "has-error" %}
							{% endif %}
							<div class="form-group {{ className }} col-xs-12 floating-label-form-group controls">
								<label>Name</label>
								<input type="text" name="name.full" value="{{ formData['name.full'] | default('') }}" class="form-control" placeholder="Name">
							</div>
							{% set className = "" %}
							{% if validationErrors.email %}
								{% set className = "has-error" %}
							{% endif %}
							<div class="form-group {{ className }} col-xs-12 floating-label-form-group controls">
								<label>Email</label>
								<input type="email" name="email" value="{{ formData.email | default('') }}" class="form-control" placeholder="E-mail">
							</div>
							<div class="form-group col-xs-12 floating-label-form-group controls">
								<label>Phone</label>
								<input type="text" name="phone" value="{{ formData.phone | default('') }}" placeholder="Phone Number (Optional)" class="form-control">
							</div>
							{% set className = "" %}
							{% if validationErrors.enquiryType %}
								{% set className = "has-error" %}
							{% endif %}
							<div class="form-group {{ className }} col-xs-12 floating-label-form-group controls">
								<span class="title-label text-muted">What are you contacting us about?</span>
								<br>
									<select name="enquiryType" class="form-control">
										<option value="">(select one)</option>
										{% for type in enquiryTypes %}
											{% set selected = "" %}
											{% if formData.enquiryType === type.value %}
												{% set selected = " selected" %}
											{% endif %}
											<option value="{{ type.value }}"{{ selected }}>{{ type.label }}</option>
										{% endfor %}
									</select>
							</div>
							{% set className = "" %}
							{% if validationErrors.message %}
								{% set className = "has-error" %}
							{% endif %}
							<div class="form-group {{ className }} col-xs-12 floating-label-form-group controls">
								<label>Message</label>
								<textarea rows="5" class="form-control" placeholder="Message" name="message"></textarea>
								{{ formData.message }}
							</div>
							<br>
							<div class="row">
								<div class="form-group col-xs-12">
									<button type="submit" class="btn btn-default">Send</button>
								</div>
							</div>
						</form>
					</div>
				</div>
			{% endif %}
		</div>
	{% endblock %}

6- Open templates/themes/newBlog/views/gallery.swig and replace the code with the following code:

	{% extends "../layouts/default.swig" %}

	{% block intro %}
		<div class="container">
			<h1>Gallery</h1>
		</div>
	{% endblock %}

	{% block content %}
		<div class="container">
			{% if galleries.length %}
				{% for gallery in galleries %}
					<h2>{{ gallery.name }}
						{% if gallery.publishedDate %}
							<span class="pull-right text-muted">{{ gallery._.publishedDate.format("Do MMM YYYY") }}</span>
						{% endif %}
					</h2>
					<div class="row">
						{% if gallery.heroImage.exists %}
							<div class="gallery-image">
								<img src="{{ gallery._.heroImage.limit(0.73,200) }}">
							</div>
							<br>
							<hr>
							<div class="row">
								<div class='list-group gallery'>
								{% for image in gallery.images %}
									<div class='col-sm-6 col-xs-6 col-md-4 col-lg-4'>
										<a class="thumbnail fancybox" rel="ligthbox" href="{{ image.limit(640,480) }}">
											<img class="img-responsive" alt="" src="{{ image.limit(300,320) }}" />
										</a>
									</div>
								{% endfor %}
								</div>
							</div>
						{% else %}
							<div class="row">
								<div class='list-group gallery'>
								{% for image in gallery.images %}
									<div class='col-sm-6 col-xs-6 col-md-4 col-lg-4'>
										<a class="thumbnail fancybox" rel="ligthbox" href="{{ image.limit(640,480) }}">
											<img class="img-responsive" alt="" src="{{ image.limit(300,320) }}" />
										</a>
									</div>
								{% endfor %}
								</div>
							</div>
						{% endif %}
					</div>
				{% endfor %}
			{% else %}
				<h3 class="text-muted">There are no image galleries yet.</h3>
			{% endif %}
		</div>
	{% endblock %}

7- Open templates/themes/newBlog/views/index.swig and replace the code with the following code:

	{% extends "../layouts/default.swig" %}

	{% block content %}
	<div class="container">
			<div class="row">
				<div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
				{% for post in data.posts %}
					<div class="post-preview">
						<a href="/blog/post/{{ post.slug }}">
							<h2 class="post-title">
								{{ post.title }}
							</h2>
							<h3 class="post-subtitle">
								{{ post.content.brief | safe }}
							</h3>
						</a>
						<p class="post-meta">Posted by <span class="text-primary">
						{% if post.author %} {{ post.author.name.first }} {% endif %}
						</span> {% if post.publishedDate %}
							on {{ post._.publishedDate.format("MMMM Do, YYYY") }}
						{% endif %}</p>
					</div>
					<hr>
				{% endfor %}
					<!-- Pager -->
					{% if data.posts %}
					<ul class="pager">
						<li class="next">
							<a href="/blog">Older Posts &rarr;</a>
						</li>
					</ul>
					{% endif %}
				</div>
			</div>
		</div>

	{% endblock %}

Note that, here in index.swig we add some lines of code to show a list of posts on index page, so we need to change the index.js controller.

7a- Open routes/views/index.js and add the following highlighted lines of code:

	var keystone = require('keystone');


	exports = module.exports = function (req, res) {

		var view = new keystone.View(req, res);
		var locals = res.locals;

		// locals.section is used to set the currently selected
		// item in the header navigation.
		locals.section = 'home';

		// Add code to show posts on index
		locals.data = {
			posts: []
		};

		view.on('init', function(next) {

			 var q = keystone.list('Post').model.find()
				.where('state', 'published')
				.sort('-publishedDate')
				.populate('author')
				.limit('4');

			 q.exec(function(err, results) {
				 locals.data.posts = results;
				 next(err);
			 });
	});

		// Render the view
		view.render('index');
	};


8- Open templates/themes/newBlog/views/post.swig and replace the code with the following code:

	{% extends "../layouts/default.swig" %}

	{% block content %}
		<article>
			<div class="container">
			<a href="/blog">&larr; back to the blog</a>
				<div class="row">
					<div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
					{% if not data.post %}
						<h2>Invalid Post.</h2>
						{% else %}
						<h1>{{ data.post.title }}</h1>
						{% if data.post.publishedDate %}
							on {{ data.post._.publishedDate.format("MMMM Do, YYYY") }}
						{% endif %}
						{% if data.post.categories and data.post.categories.length %}
							in
							{% for cat in data.post.categories %}
								<a href="/blog/{{ cat.key }}">{{ cat.name }}</a>
								{% if loop.index < data.post.categories.length - 1 %}, {% endif %}
							{% endfor %}
						{% endif %}
						{% if data.post.author %}
							by {{ data.post.author.name.first }}
						{% endif %}
						<div class="post">
							{% if data.post.image.exists %}
								<div class="image-wrap">
									<img src="{{ data.post._.image.fit(750,450) }}" class="img-responsive">
								</div>
							{% endif %}
							{{ data.post.content.full | raw }}
						</div>
					{% endif %}
					</div>
				</div>
			</div>
		</article>
		<hr>
	{% endblock %}

With this block of code we finished the HTML markup changes. Now we need to apply the new stylesheet.

# Changing the stylesheet

As we choose SASS to dealing with stylesheets on keystone.js setup, we already have everything to use the SASS features.

1- Open public/styles/site/_variables.scss and replace the code for the following lines of code:


	 // Override Bootstrap variables in this file, e.g.

	$font-size-base: 14px;

	// Theme Variables

	$brand-primary: #0085A1;
	$gray-dark: lighten(black, 25%);
	$gray: lighten(black, 50%);
	$white-faded: fade(white, 80%);
	$gray-light: #eee;


Remember that we used the http://blackrockdigital.github.io/startbootstrap-clean-blog/index.html as a reference and we just picked some blocks of code, note that
the template use LESS instead SASS, but here we re-write all the code to fit SASS syntax.

2- Open public/styles/site/_layout.scss and replace the code for the following lines of code:

	// Global Components

	body {
	  @include serif;
	  font-size: 20px;
	  color: $gray-dark;
	}

	// -- Typography

	p {
	  line-height: 1.5;
	  margin: 30px 0;
	  a {
		text-decoration: underline;
	  }
	}

	h1,
	h2,
	h3,
	h4,
	h5,
	h6 {
	  @include sans-serif;
	  font-weight: 800;
	}

	a {
	  color: $gray-dark;
	  &:hover,
	  &:focus {
		color: $brand-primary;
	  }
	}

	a img {
	  &:hover,
	  &:focus {
		cursor: zoom-in;
	  }
	}

	blockquote {
	  color: $gray;
	  font-style: italic;
	}

	hr.small {
	  max-width: 100px;
	  margin: 15px auto;
	  border-width: 4px;
	  border-color: white;
	}

	// Navigation

	.navbar-custom {
	  position: absolute;
	  top: 0;
	  left: 0;
	  width: 100%;
	  z-index: 3;
	  @include sans-serif;
	  .navbar-brand {
		font-weight: 800;
	  }
	  .nav {
		li {
		  a {
			text-transform: uppercase;
			font-size: 12px;
			font-weight: 800;
			letter-spacing: 1px;
		  }
		}
	  }
	  @media only screen and (min-width: 768px) {
		background: transparent;
		border-bottom: 1px solid transparent;
		.navbar-brand {
		  color: white;
		  padding: 20px;
		  &:hover,
		  &:focus {
			color: $white-faded;
		  }
		}
		.nav {
		  li {
			a {
			  color: white;
			  padding: 20px;
			  &:hover,
			  &:focus {
				color: $white-faded;
			  }
			}
		  }
		}
	  }
	  @media only screen and (min-width: 1170px) {
		-webkit-transition: background-color 0.3s;
		-moz-transition: background-color 0.3s;
		transition: background-color 0.3s;
		/* Force Hardware Acceleration in WebKit */
		-webkit-transform: translate3d(0, 0, 0);
		-moz-transform: translate3d(0, 0, 0);
		-ms-transform: translate3d(0, 0, 0);
		-o-transform: translate3d(0, 0, 0);
		transform: translate3d(0, 0, 0);
		-webkit-backface-visibility: hidden;
		backface-visibility: hidden;
		&.is-fixed {
		  /* when the user scrolls down, we hide the header right above the viewport */
		  position: fixed;
		  top: -61px;
		  background-color: fade(white, 90%);
		  border-bottom: 1px solid darken(white, 5%);
		  -webkit-transition: -webkit-transform 0.3s;
		  -moz-transition: -moz-transform 0.3s;
		  transition: transform 0.3s;
		  .navbar-brand {
			color: $gray-dark;
			&:hover,
			&:focus {
			  color: $brand-primary;
			}
		  }
		  .nav {
			li {
			  a {
				color: $gray-dark;
				&:hover,
				&:focus {
				  color: $brand-primary;
				}
			  }
			}
		  }
		}
		&.is-visible {
		  /* if the user changes the scrolling direction, we show the header */
		  -webkit-transform: translate3d(0, 100%, 0);
		  -moz-transform: translate3d(0, 100%, 0);
		  -ms-transform: translate3d(0, 100%, 0);
		  -o-transform: translate3d(0, 100%, 0);
		  transform: translate3d(0, 100%, 0);
		}
	  }
	}

	// Header

	.intro-header {
	  background-color: $gray;
	  background: no-repeat center center;
	  background-attachment: scroll;
	  @include background-cover;
		background-image: url('../images/header-bg-1920x1440.jpg');

	  margin-bottom: 50px;
	  .site-heading,
	  .post-heading,
	  .page-heading {
		padding: 100px 0 50px;
		color: white;
		@media only screen and (min-width: 768px) {
		  padding: 150px 0;
		}
	  }
	  .site-heading,
	  .page-heading {
		text-align: center;
		h1 {
		  margin-top: 0;
		  font-size: 50px;
		}
		.subheading {
		  font-size: 24px;
		  line-height: 1.1;
		  display: block;
		  @include sans-serif;
		  font-weight: 300;
		  margin: 10px 0 0;
		}
		@media only screen and (min-width: 768px) {
		  h1 {
			font-size: 80px;
		  }
		}
	  }
	  .post-heading {
		h1 {
		  font-size: 35px;
		}
		.subheading,
		.meta {
		  line-height: 1.1;
		  display: block;
		}
		.subheading {
		  @include sans-serif;
		  font-size: 24px;
		  margin: 10px 0 30px;
		  font-weight: 600;
		}
		.meta {
		  @include serif;
		  font-style: italic;
		  font-weight: 300;
		  font-size: 20px;
		  a {
			color: white;
		  }
		}
		@media only screen and (min-width: 768px) {
		  h1 {
			font-size: 55px;
		  }
		  .subheading {
			font-size: 30px;
		  }
		}
	  }
	}

	// Post Preview Pages

	.post-preview {
	  > a {
		color: $gray-dark;
		&:hover,
		&:focus {
		  text-decoration: none;
		  color: $brand-primary;
		}
		> .post-title {
		  font-size: 30px;
		  margin-top: 30px;
		  margin-bottom: 10px;
		}
		> .post-subtitle {
		  margin: 0;
		  font-weight: 300;
		  margin-bottom: 10px;

		  p {
			margin: 0;
		  }
		}
	  }
	  > .post-meta {
		color: $gray;
		font-size: 18px;
		font-style: italic;
		margin-top: 0;
		> a {
		  text-decoration: none;
		  color: $gray-dark;
		  &:hover,
		  &:focus {
			color: $brand-primary;
			text-decoration: underline;
		  }
		}
	  }
	  @media only screen and (min-width: 768px) {
		> a {
		  > .post-title {
			font-size: 36px;
		  }
		}
	  }
	}

	// Sections

	.section-heading {
	  font-size: 36px;
	  margin-top: 60px;
	  font-weight: 700;
	}

	.caption {
	  text-align: center;
	  font-size: 14px;
	  padding: 10px;
	  font-style: italic;
	  margin: 0;
	  display: block;
	  border-bottom-right-radius: 5px;
	  border-bottom-left-radius: 5px;
	}

	footer {
	  padding: 50px 0 65px;
	  .list-inline {
		margin: 0;
		padding: 0;
	  }
	  .copyright {
		font-size: 14px;
		text-align: center;
		margin-bottom: 0;
	  }
	}

	// Contact Form Styles

	.floating-label-form-group {
	  font-size: 14px;
	  position: relative;
	  //margin-bottom: 0;
	  padding-bottom: 0.5em;
	  border-bottom: 1px solid $gray-light;
	  input,
	  textarea {
		z-index: 1;
		position: relative;
		padding-right: 0;
		padding-left: 0;
		border: none;
		border-radius: 0;
		font-size: 1.5em;
		background: none;
		box-shadow: none !important;
		resize: none;
	  }
	  label {
		display: block;
		z-index: 0;
		position: relative;
		top: 2em;
		margin: 0;
		font-size: 0.85em;
		line-height: 1.764705882em;
		vertical-align: middle;
		vertical-align: baseline;
		opacity: 0;
		-webkit-transition: top 0.3s ease,opacity 0.3s ease;
		-moz-transition: top 0.3s ease,opacity 0.3s ease;
		-ms-transition: top 0.3s ease,opacity 0.3s ease;
		transition: top 0.3s ease,opacity 0.3s ease;
	  }
	  &::not(:first-child) {
		padding-left: 14px;
		border-left: 1px solid $gray-light;
	  }

	  .title-label {
		  margin: 20px auto;
		  font-size: 20px;
		  color: #999999;
		  position: relative;
		  margin-bottom: 20px;
	  }
	  select {
		  margin-top: 10px;
	  }
	}

	.floating-label-form-group-with-value {
	  label {
		top: 0;
		opacity: 1;
	  }
	}

	.floating-label-form-group-with-focus {
	  label {
		color: $brand-primary;
	  }
	}

	form .row:first-child .floating-label-form-group {
	  border-top: 1px solid $gray-light;
	}

	// Button Styles

	.btn {
	  @include sans-serif;
	  text-transform: uppercase;
	  font-size: 14px;
	  font-weight: 800;
	  letter-spacing: 1px;
	  border-radius: 0;
	  padding: 15px 25px;
	}

	.btn-lg {
	  font-size: 16px;
	  padding: 25px 35px;
	}

	.btn-default {
	  &:hover,
	  &:focus {
		background-color: $brand-primary;
		border: 1px solid $brand-primary;
		color: white;
	  }
	}

	// Pager Styling

	.pager {

	  margin: 20px 0 0;

	  li {
		> a,
		> span {
		  @include sans-serif;
		  text-transform: uppercase;
		  font-size: 14px;
		  font-weight: 800;
		  letter-spacing: 1px;
		  padding: 15px 25px;
		  background-color: white;
		  border-radius: 0;
		}

		> a:hover,
		> a:focus {
		  color: white;
		  background-color: $brand-primary;
		  border: 1px solid $brand-primary;
		}
	  }

	  .disabled {
		> a,
		> a:hover,
		> a:focus,
		> span {
		  color: $gray;
		  background-color: $gray-dark;
		  cursor: not-allowed;
		}
	  }
	}

	// -- Highlight Color Customization

	::-moz-selection {
	  color: white;
	  text-shadow: none;
	  background: $brand-primary;
	}

	::selection {
	  color: white;
	  text-shadow: none;
	  background: $brand-primary;
	}

	img::selection {
	  color: white;
	  background: transparent;
	}

	img::-moz-selection {
	  color: white;
	  background: transparent;
	}

	body {
	  webkit-tap-highlight-color: $brand-primary;
	}

2- Create a new file called _mixins.scss inside public/styles/site/ and add following lines of code:

	// Mixins

	@mixin transition-all() {
		-webkit-transition: all 0.5s;
		-moz-transition: all 0.5s;
		transition: all 0.5s;
	}

	@mixin background-cover() {
		-webkit-background-size: cover;
		-moz-background-size: cover;
		background-size: cover;
		-o-background-size: cover;
	}

	@mixin serif() {
		font-family: 'Lora', 'Times New Roman', serif;
	}

	@mixin sans-serif () {
		font-family: 'Open Sans', 'Helvetica Neue', Helvetica, Arial, sans-serif;
	}

No we just need to edit the public/styles/site.scss to include the new mixins file.

2- Open public/styles/site.scss and add the following highlighted lines of code:

	// Bootstrap
	// =========

	// Bootstrap can be removed entirely by deleting this line.

	@import "bootstrap/bootstrap";

	// The easiest way to customise Bootstrap variables while
	// being able to easily override the source files with new
	// versions is to override the ones you want in another file.
	//
	// You can also add your own custom variables to this file for
	// use in your site stylesheets.

	@import "site/variables";

	// Add mixins
	@import "site/mixins";
	// Site Styles
	// ===========

	// Add your own site style includes here
	@import "site/layout";

3- Add the image header-bg-1290x1140.jpg from the sample-images folder (You can download all the examples files from PacktPub or on the Github official book page). To public/images/ folder.

# Adding the Gallery script

As we can see the default Keystone.js theme is very simple and uses only the Bootstrap framework. Now we will use a jQuery plugin called fancybox to apply a new style in our gallery.

1- Open templates/themes/newBlog/layouts/default.swig and add the following highlighted code at the head tag:

	{# Customise the stylesheet for your site by editing /public/styles/site.sass #}
	<link href="/styles/site.css" rel="stylesheet">

	<!-- fancyBox -->
	<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.5/jquery.fancybox.min.css" media="screen">

	{# This file provides the default styling for the KeystoneJS Content Editor #}
	{%- if user and user.canAccessKeystone -%}
		<link href="/keystone/styles/content/editor.min.css" rel="stylesheet">
	{%- endif -%}

2- Now, let's add the following highlighted lines of code to scripts at the bottom:

	{# Add scripts that are globally required by your site here. #}

	<script src="//cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.5/jquery.fancybox.min.js"></script>
	<script>
	$(document).ready(function(){
		// Gallery
		$(".fancybox").fancybox({
			openEffect: "elastic",
			closeEffect: "elastic"
		});
		// Floating label headings for the contact form
		$("body").on("input propertychange", ".floating-label-form-group", function(e) {
			$(this).toggleClass("floating-label-form-group-with-value", !!$(e.target).val());
		}).on("focus", ".floating-label-form-group", function() {
			$(this).addClass("floating-label-form-group-with-focus");
		}).on("blur", ".floating-label-form-group", function() {
			$(this).removeClass("floating-label-form-group-with-focus");
		});
	});
	</script>

	{# Include template-specific javascript files by extending the js block #}
	{%- block js -%}{%- endblock -%}

As we already use jQuery in the project, since Bootstrap depends on it, we not need  insert it again.

# Extending the keystone.js core

Now we have the new theme, almost ready.
We will now see how we can extend the core keystone.js and add another page on our blog, as the example that we are following has a page on.

1- Create a new file called About inside models/ folder and add the following code:

	var keystone = require('keystone');
	var Types = keystone.Field.Types;

	/**
	 * About Model
	 * ==========
	 */

	var About = new keystone.List('About', {
		// Using map to show title instead ObjectID on Admin Interface
		map: { name: 'title' },
		autokey: { path: 'slug', from: 'title', unique: true },
	});

	About.add({
		title: { type: String, initial: true, default: '', required: true },
		description: { type: Types.Textarea }
	});

	About.register();


2- Add the new module to admin navigation, open keystone.js at the root folder and add the following highlighted lines of code:

	// Configure the navigation bar in Keystone's Admin UI

	keystone.set('nav', {
		posts: ['posts', 'post-categories'],
		galleries: 'galleries',
		enquiries: 'enquiries',
		userAdmins: 'user-admins',
		abouts: 'abouts'
	});

Note that the word on left will be displayed at the nav bar as About menu item and the word on right is the about collection.

3- Customizing column display. Add the following highlighted lines of code, before the register() function on About.js file:

	About.defaultColumns = 'title, description|60%';

4- Adding the route to about page. Open routes/index.js and add the following highlighted lines of code:

	// Setup Route Bindings
	exports = module.exports = function (app) {
		// Views
		app.get('/', routes.views.index);
		app.get('/about', routes.views.about);
		app.get('/blog/:category?', routes.views.blog);
		app.get('/blog/post/:post', routes.views.post);
		app.get('/gallery', routes.views.gallery);
		app.all('/contact', routes.views.contact);

		// NOTE: To protect a route so that only admins can see it, use the requireUser middleware:
		// app.get('/protected', middleware.requireUser, routes.views.protected);
	};
5- Now let's create the controller for the routes.views.blog. Create a new file called about.js inside routes/views/ folder and add the following code:

	var keystone = require('keystone');


	exports = module.exports = function (req, res) {

		var view = new keystone.View(req, res);
		var locals = res.locals;

		// locals.section is used to set the currently selected
		// item in the header navigation.
		locals.section = 'about';

		// Add code to show posts on index
		locals.data = {
			abouts: []
		};

		view.on('init', function(next) {

			var q = keystone.list('About').model.find()
				.limit('1');

			q.exec(function(err, results) {
				locals.data.abouts = results;
				next(err);
			});
	});

		// Render the view
		view.render('about');
	};


6- Add the route on routes/middleware.js, as the following highlighted code:

	exports.initLocals = function (req, res, next) {
		res.locals.navLinks = [
			{ label: 'Home', key: 'home', href: '/' },
			{ label: 'About', key: 'about', href: '/about' },
			{ label: 'Blog', key: 'blog', href: '/blog' },
			{ label: 'Gallery', key: 'gallery', href: '/gallery' },
			{ label: 'Contact', key: 'contact', href: '/contact' },
		];
		res.locals.user = req.user;
		next();
	};

# Adding content to application

1- Got to http://localhost:3000/keystone, use the user: john@doe.com and password: 123456 to access the control panel.

2- Go  to http://localhost:3000/keystone/post-categories, add a category called old cars.

3- Go to http://localhost:3000/keystone/posts, click on Create Post button and add the following title:
Sample Post Example Without Image I.
